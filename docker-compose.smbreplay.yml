# SMB Replay API Service
# This fragment can be merged into the tracer docker-compose.yml
#
# To use, add this service to docker-compose.yml and ensure volumes match.

services:
  smbreplay-api:
    build:
      context: ./smbreplay  # Path to smbreplay repo relative to tracer
      dockerfile: Dockerfile
    container_name: tracer-smbreplay-api
    ports:
      - '3004:3004'
    environment:
      - PORT=3004
      - TRACES_FOLDER=/stingray
      - SESSION_OUTPUT=/output
      # Use Docker network hostname (postgres service name) instead of localhost
      # Set DATABASE_URL_DOCKER in .env, or it builds from POSTGRES_PASSWORD
      - DATABASE_URL=${DATABASE_URL_DOCKER:-postgresql://tracer:${POSTGRES_PASSWORD}@postgres:5432/tracer?schema=public&connect_timeout=10}
      - PYTHONUNBUFFERED=1
    volumes:
      - ${STINGRAY:-~/cases}:/stingray:ro
      - ${SESSION_OUTPUT:-./output}:/output
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3004/health']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    # Optional: Add network for internal service communication
    # networks:
    #   - tracer-network
